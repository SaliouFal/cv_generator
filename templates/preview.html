<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>AperÃ§u du CV</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* â”€â”€â”€â”€â”€ Spinner plein-Ã©cran â”€â”€â”€â”€â”€ */
    #spinner-overlay {
      position: fixed;
      inset: 0;                          /* top:0 right:0 bottom:0 left:0 */
      background: rgba(255,255,255,.8);
      display: none;                     /* cachÃ© par dÃ©faut */
      align-items: center;
      justify-content: center;
      z-index: 1050;                     /* > modal bootstrap (1040) */
    }

    /* lâ€™aperÃ§u prend toute la largeur et 75â€¯% de la hauteurâ€‘Ã©cran */
  #cvpdf{
    width:100%;
    height:75vh;         /* vue verticale : 75â€¯% de la hauteur */
    border:none;
  }
  /* un peu plus bas sur les trÃ¨s petits Ã©crans */
  @media (max-width:768px){
    #cvpdf{height:60vh;}
  }
  </style>


</head>

<body class="p-5">
<div class="container">

  <h1 class="mb-4">PrÃ©-visualisation</h1>

  <!-- anti-cache avec ?t={{ ts }} -->
  <embed id="cvpdf"
         src="{{ url_for('file', filename=pdf_filename) }}?t={{ ts }}"
         type="application/pdf"
         width="100%" height="700px" />
  
  
  <!-- Aide : comment utiliser le champ Â«â€¯Instructionâ€¯Â» ---------------------- -->
<div class="alert alert-light border shadow-sm small" id="howto-instructions">
  <p class="mb-1">
    <strong>ğŸ’¡&nbsp;Astuce&nbsp;:</strong> vous pouvez demander Ã  lâ€™IA
    dâ€™<em>ajouter</em>, de <em>supprimer</em> ou de <em>rÃ©Ã©crire</em> nâ€™importe
    quel Ã©lÃ©ment de votre CV. Tapez votre demande dans la zone
    <b>Instruction</b>, puis cliquez sur <b>Appliquer</b>.
  </p>

  <p class="mb-0">Exemples&nbsp;:</p>
  <ul class="mb-1 ps-4">
    <li>Â«â€¯RÃ©sume toutes les descriptions dâ€™expÃ©rience Ã  2&nbsp;phrasesâ€¯Â»</li>
    <li>Â«â€¯RÃ©duis le profil professionnel Ã  3&nbsp;lignes percutantesâ€¯Â»</li>
    <li>Â«â€¯Supprime la licence Professionnelle si le CV fait deux pagesâ€¯Â»</li>
    <li>Â«â€¯Ajoute la compÃ©tence â€œDockerâ€ dans la liste Skillsâ€¯Â»</li>
    <li>Â«â€¯Corrige les fautes de franÃ§ais dans tout le CVâ€¯Â»</li>
  </ul>

  <small class="text-muted">
    Lâ€™IA applique uniquement votre demande&nbsp;; rien dâ€™autre nâ€™est modifiÃ©.
  </small>
</div>

  <!-- Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­ Formulaire dâ€™instruction JSON Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­ -->
  <form id="json-edit-form"
        action="{{ url_for('json_edit_prepare') }}"
        method="post" class="mt-4">

    <label class="form-label fw-semibold">Instruction&nbsp;:</label>
    <textarea class="form-control" name="instruction" rows="3"
              placeholder="Ex : ajoute une langue Espagnol niveau IntermÃ©diaire"
              required></textarea>

    <!-- Boutons ----------------------------------------------------------- -->
    <div class="mt-3 d-flex gap-2">
      <button class="btn btn-primary">Appliquer</button>

      <button id="btn-diagnostic" class="btn btn-outline-secondary">
        ğŸ“Š Diagnostiquer mon CV
      </button>

      <a href="{{ url_for('download') }}" class="btn btn-success">TÃ©lÃ©charger</a>
      <a href="{{ url_for('index') }}" class="btn btn-secondary">Revenir au choix de modÃ¨le</a>
    </div>
  </form>

  <!-- Zone diagnostic (cachÃ©e) ------------------------------------------- -->
  <div id="diagnostic-zone" class="d-none">
    <h3 class="mt-4">Diagnostic de votre CV</h3>
    <p id="global-score" class="fw-bold"></p>

    <div class="table-responsive">
      <table id="diag-table" class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Zone</th><th>ProblÃ¨me</th><th>Pourquoi</th><th>Suggestion</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h5>PrioritÃ©s de correction</h5>
    <ol id="priority-list"></ol>
  </div>

</div>

<!--  Spinner overlay ----------------------------------------------------- -->
<div id="spinner-overlay">
  <div class="spinner-border text-primary" role="status" style="width:4rem;height:4rem;">
    <span class="visually-hidden">Chargementâ€¦</span>
  </div>
</div>

<!-- Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­ JS Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­Â­ -->
<script>
document.getElementById('btn-diagnostic').addEventListener('click', async (evt) => {
  evt.preventDefault();                       // Ã©vite le submit du formulaire

  const zone   = document.getElementById('diagnostic-zone');
  const tbody  = document.querySelector('#diag-table tbody');
  const score  = document.getElementById('global-score');
  const plist  = document.getElementById('priority-list');
  const btn    = evt.currentTarget;
  const spin   = document.getElementById('spinner-overlay');

  // UI : dÃ©sactive le bouton + affiche spinner
  btn.disabled = true;
  btn.innerText = 'Analyse en coursâ€¦';
  spin.style.display = 'flex';

  try {
    const r   = await fetch('{{ url_for("cv_diagnostic") }}');
    if (!r.ok) throw new Error(await r.text());
    const data = await r.json();

    /* -------- Affichage rÃ©sultats -------- */
    score.textContent = `Note globale : ${data.score}/20`;

    tbody.innerHTML = '';
    data.issues.forEach(row => {
      tbody.insertAdjacentHTML('beforeend',
        `<tr><td>${row.zone}</td><td>${row.problem}</td>
             <td>${row.why}</td><td>${row.suggestion}</td></tr>`);
    });

    plist.innerHTML = '';
    data.priorities.forEach(p =>
      plist.insertAdjacentHTML('beforeend', `<li>${p}</li>`));

    zone.classList.remove('d-none');
    zone.scrollIntoView({behavior:'smooth'});
  }
  catch (err) {
    console.error(err);
    alert('Erreur diagnostic : ' + err.message);
  }
  finally {
    // remets lâ€™UI en Ã©tat
    spin.style.display = 'none';
    btn.disabled = false;
    btn.innerHTML = 'ğŸ“Š Diagnostiquer mon CV';
  }
});
</script>
</body>
</html>
